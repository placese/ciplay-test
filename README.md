# CiPlay - Тестовое задание

## Описание работы сервиса

Микросервис для счетчиков статистики. Сервис взаимодействует с клиентом при помощи REST API.

### Метод сохранения статистики

Принимает на вход:

| --- | --- |
| date | Дата события |
| [views] | Количество показов |
| [clikcs] | Количество кликов |
| [cost] | Стоимость кликов |

Сохраняет запись в базу данных

### Метод показа статистики

Принимает на вход:

| --- | --- |
| from | Дата начала периода (включительно) |
| to | Дата окончания периода |
| [sort] | Поле для сортировки (date : по умолчанию, views, clicks, cost, cpc, cpm) |

Возвращает отсортированную статистику в заданном периоде со следующими полями:

| --- | --- |
| date | Дата события |
| views | Количество показов |
| clikcs | Количество кликов |
| cost | Стоимость кликов |
| cpc | Средняя стоимость клика |
| cpm | Средняя стоимость 1000 показов |

### Метод сброса статистики

Удаляет всю сохраненную стастистику

## Описание реализации

Бэкенд: Python, FastAPI, uvicorn
СУБД: PostgreSQL, SQLAlchemy
Тестирование: pytest

**app/ - корень приложения**

**server/main.py:**

- get_statistics реализует *HTTP GET* запрос для показа статистики
- create_statistics релизует *HTTP POST* запрос для сохранения статистики
- update_statistics реализует *HTTP PUT* запрос для обновлеия/создания стаститики
- drop_statistics релизует *HTTP DELETE* запрос для сброса статистики

**config/config.py:**

Файл с базовыми настройками. Берет credentials для БД из .env файла с помощью *environs*

**database/:**

Модуль для работы с базой данных

- database.py - создание подключения к базе данных и сессии
- models.py - описание модели статистики
- schemas.py - pydantic модели для валидации данных
- crud.py:

Реализует CREATE/READ/UPDATE/DELETE функции работы с БД.

get_statistics - реализует получение данных стастистики из БД. Принимает на вход from_date и to_date. Возвращает список json представлений статистики за период указанный период.
create_statistics - реализует создание записи статистики в БД. Принимает на вход json представление статистики, данные о которой нужно создать и возвращает его.
update_statistics - реализует обновление записи статистики в БД. Принимает на вход json представление статистики, данные о которой нужно обновить и возвращает его.
delete_statistics - удаляет всю статистики в БД. Возвращает количество удаленных записей.

**services/statistics_handler.py:**

Релизует бизнес-логику для обработки данных.

sort_statistics_list - возвращает отсортированный список для просмотра статистики. Принимает на вход список json представлений статистики, которую нужно отсортировать и sort - поле для сортировки
calculate_CPC_and_CPM - возвращает список для просмотра статистики с рассчитанными CPC и CPM.

**tests/**

Модуль тестирование

conftest.py - фикстуры
test_api.py - тестирование API
test_services - тестирование бизнес-логики
test.env - файл с конфигурациями для тестовой БД

## Запуск

1. Установить Python 3.10 или выше
2. Создать виртуальное окружение, активировать его и установить зависомости:
```
python3.10 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```
3. Установить PostgreSQL, создать базу данных и внести credentials в .env для базы данных и app/tests/test.env для тестовой базы данных
4. Запустить сервис из директории app/
```
uvicorn server.main:app --reload
```
5. Можно протестировать по 127.0.0.1:8000/docs


